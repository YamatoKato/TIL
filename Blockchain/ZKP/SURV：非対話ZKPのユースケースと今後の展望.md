# 非対話 ZKP のユースケースと今後の展望

## 概要

- 日付: 2024-04-29
- キーワード: Blockchain,ZKP,NIZKP,zk-SNARKs,zk-STARKs, 応用

## 目的/背景

- Blockchain コンテキストにおける ZKP の狙い

- オンチェーンと L2 の境界は何処にあるのか

- ZKP で利用できるデータとはどのようなデータなのか

- Blockchain のコンテキストで現状の ZKP の活用事例について調べる

- その他の領域で ZKP がどのように使われているのか調べる

- ZKP を用いたアプリケーション開発方法について調べる

- 今後のクリプト領域における ZKP の使われ方を模索する
  - スケーラビリティという観点での L2 Solution は競合が多すぎるから研究内容として避けたい

## Blockchain コンテキストにおける ZKP の狙い

### 情報の秘匿化

トランザクションの詳細を公開することなく、その正当性を証明することができるため、ユーザーは自身のプライバシーを保ちながらトランザクションを行うことが可能。

### データ量・計算量の圧縮

複雑なデータや計算をオフチェーンで処理し、その結果の正当性のみをオンチェーンで検証することが可能。これにより、ブロックチェーンの処理負荷が軽減され、より多くのトランザクションを迅速に処理できるようになる。
また、データ・計算量の圧縮ができるため、スケーラビリティを向上させることができる。特に、Ethereum のようなプラットフォームでは、ガス代の削減にも繋がる。

    L2 のアプリケーション上で ZKP をうまく活用することで オンチェーンを Web2 寄りの UX に変化させる。

(- ガス代の急激な高騰などを気にせずにチェーンを利用できる

- e.g. NFT の一括購入
- https://open.spotify.com/episode/0VN4cFD9EhojH3pVQr0OK6?si=oIXOXVaOQXSXrqCcbocARw&context=spotify%3Ashow%3A1zOQRHyJm2JhklnCz4qd5u&t=799
- TODO: もしガスコストを気にしなければ、Blockchain で何が実現できるのか
  )

## そもそも 非対話 ZKP で利用できるデータ（知識）とはどのようなものか

証明者の持つ知識とは「証明者が現実的な時間で計算できるもの」である。つまり、ZKP の生成と検証が効率的に行われることが重要であるため、非常に複雑で時間がかかる計算を必要とする知識は、実用的な ZKP の生成には適していない。

### zk-SNARKs の場合

1. L2 システム側である秘密の値(R)とプログラム C から証明鍵(pk)と承認鍵(vk)を生成する。

2. 証明鍵(pk)と機密情報 X(証明する情報) と X のハッシュ値(h)から証明値(prf)をつくる。prf = P(pk, X, h)

3. 承認者が承認鍵(vk)、証明値(prf)、機密情報のハッシュ値(h)を「正当か不正か」を返す検証アルゴリズムにインプット。 V(vk, h, prf) = True or False ）

※ キーの生成 G と証明値の生成アルゴリズム P の実行者が共謀していると検証結果を「真」に操作できる（Trusted setup）

### 適したデータ X（知識）

- 身元情報
  - 年齢や国籍などの個人情報が要件を満たしていることの証明
  - 運転免許証やパスポートなどの身分証明書の有効性
- 資格や権限
  - 学位や資格証明書の有効性
  - システムへのアクセス権限があることの証明
- 金融関連情報
  - 銀行口座の残高が特定の金額以上であること
  - クレジットスコアが一定の基準を満たしていること
- デジタルアセットの所有権
  - 暗号通貨やトークンの所有権
  - デジタルアートや NFT（Non-Fungible Token）の所有権
- 一連処理の実行情報
  - 取引の存在や正当性を証明
  - オフチェーンで処理した実行結果をオンチェーンに保存していなくても内容を証明できる(Blockchain の Tx 検証)

### 適していないデータ X（知識）

- 完全なデータ開示が必要な情報
  - 法的文書や契約書の全文
  - 医療記録や教育記録など、詳細な情報共有が必要な場合
- リアルタイム性が求められるデータ
  - 株価や通貨の為替レートなど、リアルタイムでの正確なデータが必要な場合
  - 緊急サービスの提供に関連する情報
- 大量のデータを含む情報
  - ビッグデータや複雑なデータセット
  - ZKP の計算コストが高くなり、実用性が低下する可能性がある

## 現状のユースケース(Blockchain 領域)

まずブロックチェーンで ZKP を使うメリットについて、
ZKP がブロックチェーンにもたらす影響として 「データ量・計算量の圧縮」 と 「情報の秘匿化」 が挙げた。

### データ量・計算量の圧縮

Ethereum 系のブロックチェーンは一つの block で扱える GasUnit（ブロックチェーン上の処理の単位）の上限があり、複雑な計算はその上限に達する可能性があるため。そこで、データ量と計算量の圧縮を試みるため、オフチェーンに複雑な計算を委託させ、ZKP を利用しその計算の正当性のみをオンチェーンに書き込む。

- zkRollup
- Hyper Oracle
- Mina Protocol

### 情報の秘匿化

ブロックチェーン上の情報は全て公開されているため、公開したくない情報などは扱うことができない。
しかし、ZKP を使うとその情報を持っているということを、その情報を明かすことなく証明できるので、パブリックが前提のブロックチェーンにプライベートの概念を持ち込むことができる。

- tornado cash

### zk-Rollup

Etheruem に書き込まれる rollup のトランザクションの正しさを ZKP を利用して証明し確定する方法。
この手法を使う zkSync Era の場合、zkSync のトランザクションをまとめてハッシュ化し、そのハッシュ値と state の差分のみを Ethereum に保存する。そして、そのハッシュ値が正しいことを ZKP を用いて証明している。
ハッシュ値を Ethereum に保存したものの、まだこのハッシュ値が本当に rollup のトランザクションをまとめてハッシュ化したものかはわからないため、rollup のトランザクションをまとめたという情報を ZKP を活用して証明する。

zkRollup では、rollup のトランザクションが存在していることを、Ethereum に渡すことなく Ethereum 上で証明することができる。

### Hyper Oracle

[ホワイトペーパー：HyperOracle: A Programmable zkOracle Protocol](https://mirror.xyz/orablog.eth/qbefsToFgFxBZBocwlkX-HXbpeUzZiv2UB5CmxcaFTM)

zkOracle プロトコルは、Ethereum ブロックチェーンからブロックヘッダーとデータルーツを安全に取得する zkPoS を提供している。従来の方法では、データソースとして外部の信頼されたサービス（例えば Infura）を使用することが一般的でしたが、zkPoS を使用することで、データの取得と検証を完全に分散化し、より信頼性の高い方法で行うことが可能となる。
また、プログラマブルなカスタマイズされたオフチェーン計算とデータマッピングを定義する zkGraph、そしてこれらを信頼できる安全な方法で処理する zkWASM の 3 つの主要コンポーネントから構成されている。
オンチェーンデータをソースとして使用することで、以下のような活用が期待できる。

- オートメーション（zkAutomation）
  HyperOracle の zkAutomation は、スマートコントラクトの自動実行を支援するメタアプリケーションです。このシステムは、オンチェーンデータ（ブロックチェーン上のデータ）をソースとして使用し、オフチェーン（ブロックチェーン外）での計算を行い、その結果を再びオンチェーンで利用可能にします。このプロセス全体は、ゼロ知識証明によって保護され、データの正確性と計算の正当性が保証されます。

- インデックス作成（zkIndexing）
  同様に、zkIndexing はブロックチェーンデータを効率的にクエリ可能な形式に整理するためのメタアプリケーションです。このサービスは、オンチェーンデータを取得し、それをオフチェーンでインデックス化し、整理されたデータを提供します。ここでも、ゼロ知識証明が使用され、提供されるデータの正確性とセキュリティが強化されます

要するに、Hyper Oracle は、zkPoS を使用してブロックチェーンデータを取得し、zkGraph と zkWASM を使用してそのデータを処理し、zkAutomation と zkIndexing を使用してそのデータを活用することができるプロトコルです。

### tornado cash

「情報の秘匿化」のユースケースとして tornado cash が挙げられる。
暗号資産のミキシングサービスで、アドレスの結びつきを分断するために利用されています。
例えば、友人に Ethereum を送った場合、友人は自分のアドレスがわかってしまうので、過去の履歴やこれからの行動全てが友人にわかってしまうことになる。そうなると、プライバシーがなくなる。そこで、tornado cash を使ってアドレスの追跡を困難にすることができる。

### Mina Protocol

Mina は、チェーンを形成する一連のブロックが存在することだけを証明することで、他のチェーンで本来行っていた各ノードがブロックを 1 つずつ検証していくという作業が不要になる。新しいブロックが作成されるたびに、mina はブロックの全シーケンスを再検証するのではなく、証明文をわずかに微調整するだけである。その代わりに、あるブロックの並びに対して有効な証明があったことを証明する。つまり新しいブロックが生成され、ネットワークにブロードキャストされるたびに、この余分なブロックをサポートするために証明を拡張するのである。

- Snarky というプログラミング言語で zk-SNARKs をサポートしてる

- ゼロ知識スマートコントラクト（zkApps）

## 現状のユースケース(Blockchain 以外の領域)

- 認証
- デジタル ID の検証
- TODO: もっとありそう

### 認証

Bob さん（検証者）が Alice さん（証明者）の本人確認をしたいとする。ALice さんは Alice さんしか持っていない秘密情報`s`
を使って、Bob さんに本人であることを伝える。認証プロトコルは秘密情報を使って Alice さんであることを確認できるプロトコルだが、言い換えると

**「A さんは秘密情報 `s` を持っている」という知識の所持**に対するゼロ知識証明（知識の証明）

である。
秘密情報`s`を持っているのは Alice さんだけなので、証明ができるのは Alice さんだけ。証明ができたという事実は、そのまま本人確認に繋がる。

### 電子署名

電子署名は、秘密情報`s`
で署名することで確かに本人が作成した文書であること（かつ改ざんがないこと）を保証するプロトコル。これは言い換えると

**「署名した人が秘密情報`s`を所持している」という知識の所持**に対する非対話ゼロ知識証明（知識の証明）
になる。署名は秘密情報を知らなければ作ることが出来ない。つまり A さんが署名していれば、

「A さんが秘密情報`s`を持っていたこと」をゼロ知識証明する

ことになる。

## 今後のアプローチ

### トランザクション処理,スマコン処理結果をプライバシー的な意味で隠蔽する

TODO

### オンチェーンで出来ない(コスト難)ような処理をオフチェーン(L2)に委託する

TODO

- オンチェーンの何かしらのサービスにアクセスするためのサブスクリプションサービスの導入

  - スマコンでサブスク処理を書くことは、オフチェーンのオラクルがまとわりついてきて難しいらしい

- NFT の一括購入 Tx を L2 で巻き取る(Rollup)。

### プロトコルレベルでの ZKP の活用

ブロックの検証を ZKP で行うことで、ブロックチェーンのスケーラビリティを向上させることができる。ブロックチェーンの全てのノードが全てのブロックを検証する必要がなくなるため、ネットワーク全体の処理速度が向上し、トランザクションの承認時間が短縮される。 by Mina Protocol

TODO

## 参考資料

- [ZKP（zkSNARKs）の使い方と活用事例](https://zenn.dev/0xywzx/articles/bdb6c991f3fc8b)

## まとめ/所感/問題点

- zk-Rollup、Hyper Oracle, tornado cash の仕組みを深ぼってみる
- Blockchain 以外の領域での ZKP の使われ方を実際のサービスを例にもっと探してみる。
- 今後の ZKP を利用できそうなアプローチを考えてみる
