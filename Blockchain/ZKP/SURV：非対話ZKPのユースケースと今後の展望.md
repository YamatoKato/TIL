# 非対話 ZKP のユースケースと今後の展望

## 概要

- 日付: 2024-04-29
- キーワード: Blockchain,ZKP,NIZKP,zk-SNARKs,zk-STARKs, 応用

## 目的/背景

- Blockchain コンテキストにおける ZKP の狙い

- オンチェーンと L2 の境界は何処にあるのか

- ZKP で利用できるデータとはどのようなデータなのか

- Blockchain のコンテキストで現状の ZKP の活用事例について調べる

- その他の領域で ZKP がどのように使われているのか調べる

- ZKP を用いたアプリケーション開発方法について調べる

- 今後のクリプト領域における ZKP の使われ方を模索する
  - スケーラビリティという観点での L2 Solution は競合が多すぎるから研究内容として避けたい

## Blockchain コンテキストにおける ZKP の狙い

### 情報の秘匿化

トランザクションの詳細を公開することなく、その正当性を証明することができるため、ユーザーは自身のプライバシーを保ちながらトランザクションを行うことが可能。

### データ量・計算量の圧縮

複雑なデータや計算をオフチェーンで処理し、その結果の正当性のみをオンチェーンで検証することが可能。これにより、ブロックチェーンの処理負荷が軽減され、より多くのトランザクションを迅速に処理できるようになる。
また、データ・計算量の圧縮ができるため、スケーラビリティを向上させることができる。特に、Ethereum のようなプラットフォームでは、ガス代の削減にも繋がる。

    L2 のアプリケーション上で ZKP をうまく活用することで オンチェーンを Web2 寄りの UX に変化させる。

## そもそも 非対話 ZKP で利用できるデータ（知識）とはどのようなものか

証明者の持つ知識とは「証明者が現実的な時間で計算できるもの」である。つまり、ZKP の生成と検証が効率的に行われることが重要であるため、非常に複雑で時間がかかる計算を必要とする知識は、実用的な ZKP の生成には適していない。

### zk-SNARKs の場合

1. L2 システム側である秘密の値(R)とプログラム C から証明鍵(pk)と承認鍵(vk)を生成する。

2. 証明鍵(pk)と機密情報 X(証明する情報) と X のハッシュ値(h)から証明値(prf)をつくる。prf = P(pk, X, h)

3. 承認者が承認鍵(vk)、証明値(prf)、機密情報のハッシュ値(h)を「正当か不正か」を返す検証アルゴリズムにインプット。 V(vk, h, prf) = True or False ）

※ キーの生成 G と証明値の生成アルゴリズム P の実行者が共謀していると検証結果を「真」に操作できる（Trusted setup）

### 適したデータ X（知識）

- 身元情報
  - 年齢や国籍などの個人情報が要件を満たしていることの証明
  - 運転免許証やパスポートなどの身分証明書の有効性
- 資格や権限
  - 学位や資格証明書の有効性
  - システムへのアクセス権限があることの証明
- 金融関連情報
  - 銀行口座の残高が特定の金額以上であること
  - クレジットスコアが一定の基準を満たしていること
- デジタルアセットの所有権
  - 暗号通貨やトークンの所有権
  - デジタルアートや NFT（Non-Fungible Token）の所有権
- 一連処理の実行情報
  - 取引の存在や正当性を証明
  - オフチェーンで処理した実行結果をオンチェーンに保存していなくても内容を証明できる(Blockchain の Tx 検証)

### 適していないデータ X（知識）

- 完全なデータ開示が必要な情報
  - 法的文書や契約書の全文
  - 医療記録や教育記録など、詳細な情報共有が必要な場合
- リアルタイム性が求められるデータ
  - 株価や通貨の為替レートなど、リアルタイムでの正確なデータが必要な場合
  - 緊急サービスの提供に関連する情報
- 大量のデータを含む情報
  - ビッグデータや複雑なデータセット
  - ZKP の計算コストが高くなり、実用性が低下する可能性がある

## 現状のユースケース(Blockchain 領域)

まずブロックチェーンで ZKP を使うメリットについて、
ZKP がブロックチェーンにもたらす影響として 「データ量・計算量の圧縮」 と 「情報の秘匿化」 が挙げた。

### データ量・計算量の圧縮

Ethereum 系のブロックチェーンは一つの block で扱える GasUnit（ブロックチェーン上の処理の単位）の上限があり、複雑な計算はその上限に達する可能性があるため。そこで、データ量と計算量の圧縮を試みるため、オフチェーンに複雑な計算を委託させ、ZKP を利用しその計算の正当性のみをオンチェーンに書き込む。

- zkRollup
- Hyper Oracle
- Mina Protocol

### 情報の秘匿化

ブロックチェーン上の情報は全て公開されているため、公開したくない情報などは扱うことができない。
しかし、ZKP を使うとその情報を持っているということを、その情報を明かすことなく証明できるので、パブリックが前提のブロックチェーンにプライベートの概念を持ち込むことができる。

- tornado cash
- SISMO
- sealcred

### zk-Rollup

Etheruem に書き込まれる rollup（複数の Tx がまとまった単位） がオフチェーン上で正しく検証されているかを ZKP を利用して証明し確定する方法。
この手法を使う zkSync Era の場合、zkSync のトランザクションをまとめてハッシュ化し、そのハッシュ値と state の差分のみを Ethereum に保存する。そして、そのハッシュ値が正しいことを ZKP を用いて証明している。
ハッシュ値を Ethereum に保存したものの、まだこのハッシュ値が本当に rollup のトランザクションをまとめてハッシュ化したものかはわからないため、rollup のトランザクションをまとめたという情報を ZKP を活用して証明する。

zkRollup では、rollup のトランザクションが存在していることを、Ethereum に渡すことなく Ethereum 上で証明することができる。

### Hyper Oracle

[ホワイトペーパー：HyperOracle: A Programmable zkOracle Protocol](https://mirror.xyz/orablog.eth/qbefsToFgFxBZBocwlkX-HXbpeUzZiv2UB5CmxcaFTM)

zkOracle プロトコルは、Ethereum ブロックチェーンからブロックヘッダーとデータルーツを安全に取得する zkPoS を提供している。従来の方法では、データソースとして外部の信頼されたサービス（例えば Infura）を使用することが一般的でしたが、zkPoS を使用することで、データの取得と検証を完全に分散化し、より信頼性の高い方法で行うことが可能となる。
また、プログラマブルなカスタマイズされたオフチェーン計算とデータマッピングを定義する zkGraph、そしてこれらを信頼できる安全な方法で処理する zkWASM の 3 つの主要コンポーネントから構成されている。
オンチェーンデータをソースとして使用することで、以下のような活用が期待できる。

- オートメーション（zkAutomation）
  HyperOracle の zkAutomation は、スマートコントラクトの自動実行を支援するメタアプリケーションです。このシステムは、オンチェーンデータ（ブロックチェーン上のデータ）をソースとして使用し、オフチェーン（ブロックチェーン外）での計算を行い、その結果を再びオンチェーンで利用可能にします。このプロセス全体は、ゼロ知識証明によって保護され、データの正確性と計算の正当性が保証されます。

- インデックス作成（zkIndexing）
  同様に、zkIndexing はブロックチェーンデータを効率的にクエリ可能な形式に整理するためのメタアプリケーションです。このサービスは、オンチェーンデータを取得し、それをオフチェーンでインデックス化し、整理されたデータを提供します。ここでも、ゼロ知識証明が使用され、提供されるデータの正確性とセキュリティが強化されます

要するに、Hyper Oracle は、zkPoS を使用してブロックチェーンデータを取得し、zkGraph と zkWASM を使用してそのデータを処理し、zkAutomation と zkIndexing を使用してそのデータを活用することができるプロトコルです。

### tornado cash

「情報の秘匿化」のユースケースとして tornado cash が挙げられる。
暗号資産のミキシングサービスで、アドレスの結びつきを分断するために利用されています。
例えば、友人に Ethereum を送った場合、友人は自分のアドレスがわかってしまうので、過去の履歴やこれからの行動全てが友人にわかってしまうことになる。そうなると、プライバシーがなくなる。そこで、tornado cash を使ってアドレスの追跡を困難にすることができる。

### Mina Protocol

Mina は、チェーンを形成する一連のブロックが存在することだけを証明することで、他のチェーンで本来行っていた各ノードがブロックを 1 つずつ検証していくという作業が不要になる。新しいブロックが作成されるたびに、mina はブロックの全シーケンスを再検証するのではなく、証明文をわずかに微調整するだけである。その代わりに、あるブロックの並びに対して有効な証明があったことを証明する。つまり新しいブロックが生成され、ネットワークにブロードキャストされるたびに、この余分なブロックをサポートするために証明を拡張するのである。

### SISMO

SISMO は、分散化、プライバシー、ユーザビリティに重点を置いたモジュール式の認証プロトコルです。このプロトコルは、トークン化された証明書（アテステーション）を発行することにより、ユーザーが自身の属性や行動を証明できるように設計されています。SISMO プロトコルでは、ZK Proof（ゼロ知識証明）が重要な役割を果たします。ZK Proof を使用することで、ユーザーは自身の情報を公開することなく、特定の条件を満たしていることを証明できます。例えば、Pythia-1 アテスターに送信された ZK Proof は、Pythia-1 Verifier コントラクトによって検証され、条件を満たしている場合には、対象のバッジが発行されます。このプロセスを通じて、ユーザーは自身の Web2 アカウントをリンクすることなく、匿名性を保ちながらデジタルアイデンティティを証明できます。

SISMO は、イーサリアムブロックチェーン上で動作する分散型アプリケーション（DApp）です。具体的には、イーサリアムのスマートコントラクトを使用しており、ユーザーが自身のデータを集約し、選択的に開示するためのプラットフォームを提供しています。SISMO Connect というシステムを通じて、アプリケーションはユーザーからのデータリクエストを一括で行うことができ、これにはゼロ知識証明が用いられています。具体的には、ユーザーは自身のデータをオンチェーンに保存することなく、オフチェーンで集約し、そのデータの正当性をゼロ知識証明によって証明します。このようにして、ユーザーは自身のデータを保護しつつ、必要な情報を提供することができます。

### sealcred

sealcred は、プライバシーを重視したデジタルアイデンティティと所有権の証明に焦点を当てたプロジェクトです。特に、NFT（Non-Fungible Token）の所有権を証明するための「zkNFT」という概念を提案しています。zkNFT を使用することで、ユーザーは自身が特定の NFT を所有していることを証明できる一方で、どの NFT を所有しているかという情報は公開せずに済みます。これにより、プライバシーを保ちつつ、NFT の所有権を証明することが可能になります。sealcred は、このようなプライバシー保護機能を提供することで、デジタルアセットの所有権証明に新たなアプローチを提供しています。

イーサリアムブロックチェーン上で動作するスマートコントラクトを使用しています。SealCred は、ユーザーが匿名でデジタルアイデンティティや資産の所有権を証明できるように設計されており、これにはゼロ知識証明が活用されています。

SealCred の実装では、特にプライバシーを重視したアプローチが取られており、ユーザーのメールアドレスなどの個人情報が第三者に露出することなく、所有権の証明が行えるようになっています。また、SealCred は分散型の検証者モデルを採用しており、中央集権的なサービスではなく、コミュニティによる検証プロセスを経て証明が行われ

- Snarky というプログラミング言語で zk-SNARKs をサポートしてる

- ゼロ知識スマートコントラクト（zkApps）

## 現状のユースケース(Blockchain 以外の領域)

- 認証
- デジタル ID の検証

### 認証

Bob さん（検証者）が Alice さん（証明者）の本人確認をしたいとする。ALice さんは Alice さんしか持っていない秘密情報`s`
を使って、Bob さんに本人であることを伝える。認証プロトコルは秘密情報を使って Alice さんであることを確認できるプロトコルだが、言い換えると

**「A さんは秘密情報 `s` を持っている」という知識の所持**に対するゼロ知識証明（知識の証明）

である。
秘密情報`s`を持っているのは Alice さんだけなので、証明ができるのは Alice さんだけ。証明ができたという事実は、そのまま本人確認に繋がる。

### 電子署名

電子署名は、秘密情報`s`
で署名することで確かに本人が作成した文書であること（かつ改ざんがないこと）を保証するプロトコル。これは言い換えると

**「署名した人が秘密情報`s`を所持している」という知識の所持**に対する非対話ゼロ知識証明（知識の証明）
になる。署名は秘密情報を知らなければ作ることが出来ない。つまり A さんが署名していれば、

「A さんが秘密情報`s`を持っていたこと」をゼロ知識証明する

ことになる。

## 今後のアプローチ

### トランザクション処理,スマコン処理結果をでプライバシー的な意味で隠蔽する Dapps の開発・提案

隠蔽するモチベーションがどこで生まれるのか?

- オンチェーン上で個人情報を扱う場合
  - e.g. デジタル ID の検証
- オンチェーン上での Tx 内容や処理結果を他者に知られたくない場合
  - e.g. デジタルアセットの所有権の証明
  - Soul Bound Token の所有権の証明（XX 大学を卒業という 2 次譲渡不能なトークン）
    - 大学名を明かさずに、トークンの所有権を証明する

### オンチェーンだとコスト難で難しい処理をオフチェーン(L2)に委託する Dapps の開発・提案

細かい処理をオンチェーンで行うとコストがかかるため、オフチェーンで処理を行い、その結果の正当性のみをオンチェーンで検証することで、コストを削減することができる狙い。

- [NFT の一括購入](https://open.spotify.com/episode/0VN4cFD9EhojH3pVQr0OK6?si=oIXOXVaOQXSXrqCcbocARw&context=spotify%3Ashow%3A1zOQRHyJm2JhklnCz4qd5u&t=799)

  - NFT の一括購入 Tx を L2 で巻き取る(Rollup)。

- オンチェーンサービスに対するサブスクリプションサービスの導入

  - バッチ処理をオフチェーンで行うことで、オンチェーンのコストを削減する
    - zkAutomation でオンチェーンのデータを取得し、オフチェーンで処理を行い、その結果を再びオンチェーンで利用可能にする (By Hyper Oracle)
  - スマコンでサブスク処理を書くことは、オフチェーンのオラクルがまとわりついてきて難しいらしい
    - オンチェーンのデータを取得するためにオラクルを使うことが多いが、オラクルの信頼性が問題になるため(e.g. Infura)

### プロトコルレベルでの ZKP の活用

ブロックの検証を ZKP で行うことで、ブロックチェーンのスケーラビリティを向上させることができる。ブロックチェーンの全てのノードが全てのブロックを検証する必要がなくなるため、ネットワーク全体の処理速度が向上し、トランザクションの承認時間が短縮される。 by Mina Protocol

全参加者ノードがフルノードになりえるように設計できる。また、ブロックチェーンのサイズを小さく保ちながら、他のブロックチェーンと同等のセキュリティを提供する

## 参考資料

- [ZKP（zkSNARKs）の使い方と活用事例](https://zenn.dev/0xywzx/articles/bdb6c991f3fc8b)

## まとめ/所感/問題点

### 所感

- ZKP は、ブロックチェーンのスケーラビリティ問題に対して、データ量・計算量の圧縮という観点で解決策を提供しているとわかった。

  - その中でも L2 での zk-Rollup の活用や開発競争が目立っていた。研究テーマにするには先行が多そう？

- L1 の protocol レベルでの ZKP の活用も興味深い

  - Mina Protocol

- ZKP を利用した Dapps 開発では、ZKPs as a Service が重要になるなと思った。

  - SISMO,SealCred のようなプロジェクトが今後増えるかもしれない

- 議論：ZKP 生成のための中央集権型プロセスを持つチェーンは、果たして分散性を持ったチェーンと呼べるのだろうか。

### 問題点

- Mina Protocol のホワイトペーパーを読み込む。

  - zk-Rollup との違いを理解する

  - プロトコルに味変ができないか検討する。

- ZKP を利用した Dapps 開発のトレンドを調べ、それぞれ深ぼる。

- ZKP を利用した Dapps 開発のためのツールやライブラリの調査

- ZKP 生成のための中央集権型プロセスを持つチェーンは、果たして分散性を持ったチェーンと呼べるのだろうか。
  - 有識者の見解を探す
